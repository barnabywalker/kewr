<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Putting conservation status on the Tree of Life • kewr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Putting conservation status on the Tree of Life">
<meta property="og:description" content="kewr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">kewr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/IPNI.html">IPNI</a>
    </li>
    <li>
      <a href="../../articles/KNMS.html">KNMS</a>
    </li>
    <li>
      <a href="../../articles/POWO.html">POWO</a>
    </li>
    <li>
      <a href="../../articles/ToL.html">ToL</a>
    </li>
    <li>
      <a href="../../articles/WCVP.html">WCVP</a>
    </li>
    <li>
      <a href="../../articles/articles/building-checklist.html">Building a species checklist</a>
    </li>
    <li>
      <a href="../../articles/articles/conservation-status-treeoflife.html">Putting conservation status on the Tree of Life</a>
    </li>
    <li>
      <a href="../../articles/articles/mapping-assessed-species.html">Mapping assessed species</a>
    </li>
    <li>
      <a href="../../articles/articles/retrieve-all-query-results.html">Retrieving all results for a query</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/barnabywalker/kewr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="conservation-status-treeoflife_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Putting conservation status on the Tree of Life</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/barnabywalker/kewr/blob/master/vignettes/articles/conservation-status-treeoflife.Rmd"><code>vignettes/articles/conservation-status-treeoflife.Rmd</code></a></small>
      <div class="hidden name"><code>conservation-status-treeoflife.Rmd</code></div>

    </div>

    
    
<p>Kew’s Tree of Life let’s us search, download, and view data related to their efforts towards building a Tree of Life for all plant and fungal genera. The most recent release focuses on a Tree of Life for angiosperm genera. This article is a small demonstration of how to view the tree and incorporate some extra data onto it.</p>
<p>To do this, we will:</p>
<ol style="list-style-type: decimal">
<li>Get assessment information for all angiosperm species listed on the IUCN Red List of Threatened Species.</li>
<li>Match those names to an IPNI ID using the Kew Names Matching Service.</li>
<li>Resolve assessments to accepted names using the World Checklist of Vascular Plants.</li>
<li>Match assessment categories to species names in the Tree of Life.</li>
<li>Plot the Tree of Life with an indication of the threat level for each species.</li>
</ol>
<p>All the species names in the Tree of Life have been aligned to the World Checklist of Vascular Plants (WCVP), so a large part of this article will be getting the IUCN Red List assessments to match that taxonomy too.</p>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>In addition to <em>kewr</em>, we’ll load:</p>
<ul>
<li>
<em>dplyr</em> to manipulate the data</li>
<li>
<em>tidyr</em> to reshape data frames</li>
<li>
<em>purrr</em> to map functions across data</li>
<li>
<em>tidylog</em> to print diagnostic information about data joins</li>
<li>
<em>stringr</em> to extract some data from strings</li>
<li>
<em>glue</em> to format strings</li>
<li>
<em>ape</em> to parse our tree data</li>
<li>
<em>ggplot2</em> to make some plots of our final data</li>
<li>
<em>ggtree</em> to visualise our tree</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://barnabywalker.github.io/kewr/">kewr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ape</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ggtree</span><span class="op">)</span></code></pre></div>
</div>
<div id="getting-assessment-information" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-assessment-information" class="anchor"></a>1. Getting assessment information</h2>
<p>I’ve already downloaded all assessments from the IUCN Red List and filtered them down to just assessments for angiosperms.</p>
<p>You can do the same by <a href="https://github.com/ropensci/rredlist">installing the <em>rredlist</em> package</a>. You’ll need an API key to use the IUCN Red List API, which you can <a href="https://apiv3.iucnredlist.org/api/v3/token">register for here</a>. Alternatively, you can download the information you need directly from <a href="https://www.iucnredlist.org/">the IUCN Red List website</a>.</p>
<p>I bundled these assessments up in this package to make things a bit easier for analysis.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">angiosperm_assessments</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;   taxonid scientific_name    taxonomic_autho~ category</span>
<span class="co">#&gt;     &lt;int&gt; &lt;chr&gt;              &lt;chr&gt;            &lt;chr&gt;   </span>
<span class="co">#&gt; 1   30310 Cotoneaster grana~ Boiss.           LR/cd   </span>
<span class="co">#&gt; 2   30312 Liquidambar orien~ &lt;NA&gt;             VU      </span>
<span class="co">#&gt; 3   30314 Prunus ramburii    Boiss.           VU      </span>
<span class="co">#&gt; 4   30315 Rhamnus intermedia Steud. &amp;amp; Ho~ LC      </span>
<span class="co">#&gt; 5   30316 Rhamnus persicifo~ Moris            EN      </span>
<span class="co">#&gt; 6   30317 Salix tarraconens~ Pau              VU</span></code></pre></div>
<p>In total, there are assessments for 53,542 angiosperm assessments.</p>
</div>
<div id="match-names-to-an-ipni-id" class="section level2">
<h2 class="hasAnchor">
<a href="#match-names-to-an-ipni-id" class="anchor"></a>2. Match names to an IPNI ID</h2>
<p>Now we need to match these names to an IPNI ID, so we can check the accepted names for them in WCVP. There are a fair number of species names we need to match, so this might take a while to run.</p>
<p>To match these names to an IPNI ID, we’ll use the Kew Names Matching Service. The first thing we’ll do, is join the taxonomic authority to the scientific name, to hopefully reduce the number of matches for each name.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">angiosperm_assessments</span> <span class="op">&lt;-</span>
  <span class="va">angiosperm_assessments</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span><span class="op">(</span><span class="st">"full_name"</span>, <span class="va">scientific_name</span>, <span class="va">taxonomic_authority</span>, sep<span class="op">=</span><span class="st">" "</span>, remove<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Then we put the full names through KNMS. We have too many names to put through KNMS at once, so we’ll split them up into smaller chunks that we can put through one after the other. <em>You might need to re-run this a couple of times until it works, as KNMS can get upset sometimes.</em></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">chunk_size</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">chunk_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">angiosperm_assessments</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">chunk_size</span>
<span class="op">)</span>

<span class="va">chunked_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">angiosperm_assessments</span><span class="op">$</span><span class="va">full_name</span>, <span class="va">chunk_idx</span><span class="op">)</span>

<span class="va">full_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">chunked_names</span>, <span class="op">~</span><span class="fu"><a href="../../reference/match_knms.html">match_knms</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  matched<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">full_matches</span>, <span class="op">~</span><span class="va">.x</span><span class="op">$</span><span class="va">matched</span><span class="op">)</span><span class="op">)</span>,
  unmatched<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">full_matches</span>, <span class="op">~</span><span class="va">.x</span><span class="op">$</span><span class="va">unmatched</span><span class="op">)</span><span class="op">)</span>,
  multiple_matches<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">full_matches</span>, <span class="op">~</span><span class="va">.x</span><span class="op">$</span><span class="va">multiple_matches</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; $matched</span>
<span class="co">#&gt; [1] 50429</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $unmatched</span>
<span class="co">#&gt; [1] 2980</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $multiple_matches</span>
<span class="co">#&gt; [1] 133</span></code></pre></div>
<p>We’ve matched a lot of our names, but still have a few thousand unmatched and a small number of assessments that matched to multiple names.</p>
<p>First we’ll try putting just the scientific names of our missing matches through KNMS again.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">full_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">full_matches</span>, <span class="va">tidy</span><span class="op">)</span>

<span class="va">unmatched</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">full_matches</span>, <span class="op">!</span><span class="va">matched</span><span class="op">)</span>

<span class="va">to_match</span> <span class="op">&lt;-</span>
  <span class="va">angiosperm_assessments</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">full_name</span> <span class="op">%in%</span> <span class="va">unmatched</span><span class="op">$</span><span class="va">submitted</span><span class="op">)</span>

<span class="va">part_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/match_knms.html">match_knms</a></span><span class="op">(</span><span class="va">to_match</span><span class="op">$</span><span class="va">scientific_name</span><span class="op">)</span>
<span class="va">part_matches</span>
<span class="co">#&gt; &lt;KNMS match: 2980 names submitted&gt;</span>
<span class="co">#&gt; Matches returned: 686</span>
<span class="co">#&gt; Multiple matches: 18</span>
<span class="co">#&gt; Unmatched names: 2276</span>
<span class="co">#&gt; List of 1</span>
<span class="co">#&gt;  $ :List of 2</span>
<span class="co">#&gt;   ..$ : chr "Liquidambar orientalis var. orientalis"</span>
<span class="co">#&gt;   ..$ : chr "false"</span></code></pre></div>
<p>A fair number of these remain unmatched, but I think that’s to be expected.</p>
<p>Now we can join all of our matches together, link them to the IUCN taxon ID, ready to resolve any synonyms.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">part_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">part_matches</span><span class="op">)</span>

<span class="va">full_matches</span> <span class="op">&lt;-</span>
  <span class="va">full_matches</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">matched</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">angiosperm_assessments</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">taxonid</span>, <span class="va">full_name</span>, <span class="va">category</span><span class="op">)</span>,
    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"submitted"</span><span class="op">=</span><span class="st">"full_name"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">part_matches</span> <span class="op">&lt;-</span>
  <span class="va">part_matches</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">matched</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">angiosperm_assessments</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">taxonid</span>, <span class="va">scientific_name</span>, <span class="va">category</span><span class="op">)</span>,
    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"submitted"</span><span class="op">=</span><span class="st">"scientific_name"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">matched_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">full_matches</span>, <span class="va">part_matches</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">matched_names</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 6</span>
<span class="co">#&gt;   submitted matched ipni_id matched_record taxonid</span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;lgl&gt;   &lt;chr&gt;   &lt;chr&gt;            &lt;int&gt;</span>
<span class="co">#&gt; 1 Cotoneas~ TRUE    722509~ Cotoneaster g~   30310</span>
<span class="co">#&gt; 2 Prunus r~ TRUE    730180~ Prunus rambur~   30314</span>
<span class="co">#&gt; 3 Rhamnus ~ TRUE    718411~ Rhamnus × int~   30315</span>
<span class="co">#&gt; 4 Rhamnus ~ TRUE    718559~ Rhamnus persi~   30316</span>
<span class="co">#&gt; 5 Salix ta~ TRUE    778993~ Salix tarraco~   30317</span>
<span class="co">#&gt; 6 Zelkova ~ TRUE    858071~ Zelkova abeli~   30319</span>
<span class="co">#&gt; # ... with 1 more variable: category &lt;chr&gt;</span></code></pre></div>
</div>
<div id="resolve-assessments-to-accepted-names" class="section level2">
<h2 class="hasAnchor">
<a href="#resolve-assessments-to-accepted-names" class="anchor"></a>3. Resolve assessments to accepted names</h2>
<p>Now that we have an IPNI ID attached to each assessment, we can look up the record for the taxa in WCVP. This will let us find out the taxonomic status of each name - the first step in resolving any synonymy issues.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># wrap up the lookup_wcvp function to make sure it comes back as a list</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">taxonid</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>status<span class="op">=</span><span class="cn">NA_character_</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/lookup_wcvp.html">lookup_wcvp</a></span><span class="op">(</span><span class="va">taxonid</span><span class="op">)</span>, silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">resolved_names</span> <span class="op">&lt;-</span>
  <span class="va">matched_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">taxonid</span>, <span class="va">ipni_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>wcvp_record<span class="op">=</span><span class="fu">f</span><span class="op">(</span><span class="va">ipni_id</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>With the taxonomic status, we’ll first remove any taxa that are unplaced. We’ll also remove any non-homotypic synonyms - even if we resolve these to accepted species, we can’t be sure that the assessment would be valid for the new concept, so that accepted species would not be assessed. We’re also only concerned about species - if we’ve matched an assessment name to a subspecies or variety, the assessment won’t apply to the matched name.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resolved_names</span> <span class="op">&lt;-</span>
  <span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>status<span class="op">=</span><span class="va">wcvp_record</span><span class="op">$</span><span class="va">status</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">status</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"accepted"</span>, <span class="st">"homotypic synonym"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rank<span class="op">=</span><span class="va">wcvp_record</span><span class="op">$</span><span class="va">rank</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">rank</span> <span class="op">==</span> <span class="st">"Species"</span><span class="op">)</span></code></pre></div>
<p>Next we’ll check if there are any taxa that still have multiple matches in WCVP.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">add_count</a></span><span class="op">(</span><span class="va">taxonid</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>multiple_matches<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">taxonid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 x 1</span>
<span class="co">#&gt;   multiple_matches</span>
<span class="co">#&gt;              &lt;int&gt;</span>
<span class="co">#&gt; 1                9</span></code></pre></div>
<p>There are 9, so we should resolve these by taking the accepted name where one was returned.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resolved_names</span> <span class="op">&lt;-</span>
  <span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">taxonid</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">status</span> <span class="op">==</span> <span class="st">"accepted"</span><span class="op">)</span></code></pre></div>
<p>Now we need to find the accepted names for all homotypic synonyms and remove anything that is still at a lower rank than species.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resolved_names</span> <span class="op">&lt;-</span>
  <span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">taxonid</span>, <span class="va">ipni_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>has_accepted<span class="op">=</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">wcvp_record</span><span class="op">$</span><span class="va">accepted</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="st">"accepted"</span> <span class="op">|</span> <span class="va">has_accepted</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accepted_id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"accepted"</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">accepted</span><span class="op">$</span><span class="va">id</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>,
         accepted_name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"accepted"</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">accepted</span><span class="op">$</span><span class="va">name</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">name</span><span class="op">)</span>,
         accepted_author<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"accepted"</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">accepted</span><span class="op">$</span><span class="va">author</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">authors</span><span class="op">)</span>,
         accepted_rank<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"accepted"</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">accepted</span><span class="op">$</span><span class="va">rank</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">rank</span><span class="op">)</span><span class="op">)</span>

<span class="va">resolved_names</span> <span class="op">&lt;-</span>
  <span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">wcvp_record</span>, <span class="op">-</span><span class="va">has_accepted</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>match_id<span class="op">=</span><span class="va">ipni_id</span><span class="op">)</span>

<span class="va">accepted_species</span> <span class="op">&lt;-</span>
  <span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">accepted_rank</span> <span class="op">==</span> <span class="st">"Species"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">accepted_species</span><span class="op">)</span>
<span class="co">#&gt; [1] 48474</span></code></pre></div>
<p>During name matching, a few assessments have been matched to the same accepted species. One reason for this is where there is an assessment for a homotypic synonym as well as the accepted name, so those two assessments match to the accepted name in WCVP. We can just remove the assessments for homotypic synonyms in these cases.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">accepted_species</span> <span class="op">&lt;-</span>
  <span class="va">accepted_species</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">accepted_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">status</span> <span class="op">==</span> <span class="st">"accepted"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">accepted_species</span>, <span class="va">accepted_id</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 7</span></code></pre></div>
<p>There are still some accepted names matched to multiple assessments. Having looked at these, they all look like differences in spelling.</p>
<p>To solve this, we can join the accepted name information back to the assessment info and keep the names, in these cases, that match the original assessment name. This will also mean our accepted names are joined up with the Red List category for the final part of our analysis.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">accepted_assessments</span> <span class="op">&lt;-</span>
  <span class="va">angiosperm_assessments</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">taxonid</span>, iucn_name<span class="op">=</span><span class="va">scientific_name</span>, <span class="va">category</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidylog</span><span class="fu">::</span><span class="fu">inner_join</span><span class="op">(</span>
    <span class="va">accepted_species</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">taxonid</span>, ipni_id<span class="op">=</span><span class="va">accepted_id</span>, wcvp_name<span class="op">=</span><span class="va">accepted_name</span>,
             wcvp_author<span class="op">=</span><span class="va">accepted_author</span><span class="op">)</span>,
    by<span class="op">=</span><span class="st">"taxonid"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ipni_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">iucn_name</span> <span class="op">==</span> <span class="va">wcvp_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">taxonid</span>, .keep_all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; inner_join: added 3 columns (ipni_id, wcvp_name, wcvp_author)</span>
<span class="co">#&gt;             &gt; rows only in x  ( 5,112)</span>
<span class="co">#&gt;             &gt; rows only in y  (     0)</span>
<span class="co">#&gt;             &gt; matched rows     48,430</span>
<span class="co">#&gt;             &gt;                 ========</span>
<span class="co">#&gt;             &gt; rows total       48,430</span></code></pre></div>
<p>Finally, there are some species assessed under the old IUCN criteria. These are almost certainly out of date, so the easiest thing to do will be to remove them. If we had downloaded the assessment year info, we’d also remove other assessments that were made before the change in criteria.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">accepted_assessments</span> <span class="op">&lt;-</span>
  <span class="va">accepted_assessments</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">category</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LC"</span>, <span class="st">"NT"</span>, <span class="st">"VU"</span>, <span class="st">"EN"</span>, <span class="st">"CR"</span>, <span class="st">"EW"</span>, <span class="st">"EX"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We’re left with 43,998 assessments matched to accepted names in WCVP.</p>
</div>
<div id="match-sequenced-species-to-assessments" class="section level2">
<h2 class="hasAnchor">
<a href="#match-sequenced-species-to-assessments" class="anchor"></a>4. Match sequenced species to assessments</h2>
<p>Now we need to match our assessment info to our Tree of Life info.</p>
<p>There we two ways we could do this - download all specimen info using <code>search_tol</code> or download the tree file using <code>load_tol</code> and parse the specimen info from the tip labels. We’ll do the second one, just in case there are specimens not used in the tree.</p>
<p>So first we’ll download the tree and parse it.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tol</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/load_tol.html">load_tol</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; No encoding supplied: defaulting to UTF-8.</span>
<span class="va">tol</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu">read.tree</span><span class="op">(</span>text<span class="op">=</span><span class="va">tol</span><span class="op">$</span><span class="va">content</span><span class="op">)</span>
<span class="va">tol</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Phylogenetic tree with 3109 tips and 3108 internal nodes.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Tip labels:</span>
<span class="co">#&gt;   17419_false_Gnetales_Gnetaceae_Gnetum_montanum, 18215_false_Ephedrales_Ephedraceae_Ephedra_sinica, 18047_false_Ginkgoales_Ginkgoaceae_Ginkgo_biloba, 18411_false_Cycadales_Cycadaceae_Cycas_micholitzii, 17387_false_Pinales_Pinaceae_Cedrus_libani, 17037_false_Pinales_Pinaceae_Picea_engelmannii, ...</span>
<span class="co">#&gt; Node labels:</span>
<span class="co">#&gt;   , 1.00, 1.00, 1.00, 1.00, 1.00, ...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Rooted; includes branch lengths.</span></code></pre></div>
<p>Now we’ll extract taxonomic info from the tip labels.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tip_info</span> <span class="op">&lt;-</span>
  <span class="va">tol</span><span class="op">$</span><span class="va">tip.label</span> <span class="op">%&gt;%</span>
    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span><span class="op">(</span>name<span class="op">=</span><span class="cn">NULL</span>, value<span class="op">=</span><span class="st">"label"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">label</span>, <span class="st">"^\\d+"</span><span class="op">)</span>,
           order<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">label</span>, <span class="st">"[^_]+ales"</span><span class="op">)</span>,
           family<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">label</span>, <span class="st">"[^_]+eae"</span><span class="op">)</span>,
           species<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">label</span>, <span class="st">"(?&lt;=eae_)\\w+$"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>species<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">species</span>, <span class="st">"_"</span>, <span class="st">" "</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>And join it to the matched assessment info.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tip_assessments</span> <span class="op">&lt;-</span>
  <span class="va">tip_info</span> <span class="op">%&gt;%</span>
  <span class="fu">tidylog</span><span class="fu">::</span><span class="fu">left_join</span><span class="op">(</span>
    <span class="va">accepted_assessments</span>,
    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"species"</span><span class="op">=</span><span class="st">"wcvp_name"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="co">#&gt; left_join: added 5 columns (taxonid, iucn_name, category, ipni_id, wcvp_author)</span>
<span class="co">#&gt;            &gt; rows only in x    2,242</span>
<span class="co">#&gt;            &gt; rows only in y  (43,180)</span>
<span class="co">#&gt;            &gt; matched rows        867</span>
<span class="co">#&gt;            &gt;                 ========</span>
<span class="co">#&gt;            &gt; rows total        3,109</span></code></pre></div>
<p>Before visualising the tree, we can take a quick look at how many of the species in it have been assessed, and how threatened the assessed ones are.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_assessed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">tip_assessments</span><span class="op">$</span><span class="va">category</span><span class="op">)</span><span class="op">)</span>
<span class="va">p_threat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tip_assessments</span><span class="op">$</span><span class="va">category</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"VU"</span>, <span class="st">"EN"</span>, <span class="st">"CR"</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tip_assessments</span><span class="op">$</span><span class="va">category</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LC"</span>, <span class="st">"NT"</span>, <span class="st">"VU"</span>, <span class="st">"EN"</span>, <span class="st">"CR"</span><span class="op">)</span><span class="op">)</span>

<span class="va">pformat</span> <span class="op">&lt;-</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">percent_format</a></span><span class="op">(</span>accuracy<span class="op">=</span><span class="fl">0.1</span>, suffix<span class="op">=</span><span class="st">" %"</span><span class="op">)</span>
<span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{pformat(p_assessed)} of the ToL species are assessed"</span>,
              <span class="st">"{pformat(p_threat)} of those are threatened"</span>,
              .sep<span class="op">=</span><span class="st">"\n"</span><span class="op">)</span>

<span class="va">colours</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NE"</span><span class="op">=</span><span class="st">"#ffffff"</span>,
              <span class="st">"DD"</span><span class="op">=</span><span class="st">"#d1d1d6"</span>,
              <span class="st">"LC"</span><span class="op">=</span><span class="st">"#60c659"</span>,
              <span class="st">"NT"</span><span class="op">=</span><span class="st">"#cce226"</span>,
              <span class="st">"VU"</span><span class="op">=</span><span class="st">"#f9e814"</span>,
              <span class="st">"EN"</span><span class="op">=</span><span class="st">"#fc7f3f"</span>,
              <span class="st">"CR"</span><span class="op">=</span><span class="st">"#d81e05"</span>,
              <span class="st">"EW"</span><span class="op">=</span><span class="st">"#542344"</span>,
              <span class="st">"EX"</span><span class="op">=</span><span class="st">"#000000"</span><span class="op">)</span>

<span class="va">tip_assessments</span> <span class="op">&lt;-</span>
  <span class="va">tip_assessments</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>category<span class="op">=</span><span class="st">"NE"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>category<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">category</span>,
                         levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">colours</span><span class="op">)</span>,
                         ordered<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">tip_assessments</span>, mapping<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">category</span>, fill<span class="op">=</span><span class="va">category</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="va">colours</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Species"</span>, title<span class="op">=</span><span class="va">title</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="figure/tol-assessment-bars-1.png" alt=""><p class="caption">plot of chunk tol-assessment-bars</p>
</div>
</div>
<div id="plotting-the-tree-of-life" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-the-tree-of-life" class="anchor"></a>5. Plotting the Tree of Life</h2>
<p>Now we can make the plot we wanted - the Tree of Life with assessment information displayed. We’re using the <code>ggtree</code> package to do this, which makes it easy to plot a phylogenetic tree and add extra info from a dataframe to it.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tip_data</span> <span class="op">&lt;-</span> <span class="va">tip_assessments</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">category</span> <span class="op">!=</span> <span class="st">"NE"</span><span class="op">)</span>

<span class="fu">ggtree</span><span class="op">(</span><span class="va">tol</span>, layout<span class="op">=</span><span class="st">"circular"</span>, colour<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span> <span class="op">%&lt;+%</span>
  <span class="va">tip_data</span> <span class="op">+</span>
  <span class="fu">geom_tippoint</span><span class="op">(</span>mapping<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>colour<span class="op">=</span><span class="va">category</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">2</span>, alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="va">colours</span>, name<span class="op">=</span><span class="st">"IUCN Red List category"</span>,
                      na.translate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Distribution of extinction risk across the angiosperm tree of life"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="figure/tol-assessment-tree-1.png" alt=""><p class="caption">plot of chunk tol-assessment-tree</p>
</div>
<p>There’s lots of scope for tweaking this - for instance, it might look better as a cladogram, or we could plot selected gene info from the ToL around the edge as a heatmap, or just label on selected orders or families.</p>
<p>But this is a start, and we can already see areas with higher coverage of assessments, and small clusters of threatened species.</p>
<p>If we had assessments for all species in this phylogeny, we could calculate an <a href="https://www.nature.com/articles/s41598-018-24365-4">EDGE score</a>, which quantifies how at risk and how evolutionarily distinct each species is.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Barnaby Walker.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
