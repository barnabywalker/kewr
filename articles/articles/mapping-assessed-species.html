<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapping assessed species • kewr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Mapping assessed species">
<meta property="og:description" content="kewr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">kewr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/IPNI.html">IPNI</a>
    </li>
    <li>
      <a href="../../articles/KNMS.html">KNMS</a>
    </li>
    <li>
      <a href="../../articles/POWO.html">POWO</a>
    </li>
    <li>
      <a href="../../articles/ToL.html">ToL</a>
    </li>
    <li>
      <a href="../../articles/WCVP.html">WCVP</a>
    </li>
    <li>
      <a href="../../articles/articles/building-checklist.html">Building a species checklist</a>
    </li>
    <li>
      <a href="../../articles/articles/conservation-status-treeoflife.html">Putting conservation status on the Tree of Life</a>
    </li>
    <li>
      <a href="../../articles/articles/mapping-assessed-species.html">Mapping assessed species</a>
    </li>
    <li>
      <a href="../../articles/articles/retrieve-all-query-results.html">Retrieving all results for a query</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/barnabywalker/kewr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="mapping-assessed-species_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Mapping assessed species</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/barnabywalker/kewr/blob/master/vignettes/articles/mapping-assessed-species.Rmd"><code>vignettes/articles/mapping-assessed-species.Rmd</code></a></small>
      <div class="hidden name"><code>mapping-assessed-species.Rmd</code></div>

    </div>

    
    
<p>This is a demonstration of one use for some of the kewr resources, in calculating the proportion of species that have been assessed in a country.</p>
<p>To do this, we’ll follow these steps:</p>
<ol style="list-style-type: decimal">
<li>Retrieve a list of assessed species in one country from the IUCN Red List of Threatened Species.</li>
<li>Match names to an IPNI ID using the Kew Names Matching Service.</li>
<li>Resolve assessments to accepted names using the World Checklist of Vascular Plants.</li>
<li>Get a list of all accepted vascular plant species in the country from Plants of the World Online.</li>
<li>Calculate the proportion of assessed and threatened species in our country of interest.</li>
</ol>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>In addition to <em>kewr</em>, we’ll load:</p>
<ul>
<li>
<em>dplyr</em> to manipulate the data</li>
<li>
<em>tidyr</em> to reshape data frames</li>
<li>
<em>stringr</em> to extract some data from strings</li>
<li>
<em>ggplot2</em> to make some plots of our final data</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://barnabywalker.github.io/kewr/">kewr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="getting-assessment-information" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-assessment-information" class="anchor"></a>1. Getting assessment information</h2>
<p>The first step in this problem is to get a list of assessed species for a country.</p>
<p>The most authoritative list of global species assessments is the IUCN Red List of Threatened Species. For this package, I used the <code>rl_sp_country</code> function from <em>rredlist</em> to request all assessments for taxa found in Denmark from the IUCN Red List API. I then used the <code>rl_search</code> function to request full assessment information for each taxon.</p>
<p>You can do the same by <a href="https://github.com/ropensci/rredlist">installing the <em>rredlist</em> package</a>. You’ll need an API key to use the IUCN Red List API, which you can <a href="https://apiv3.iucnredlist.org/api/v3/token">register for here</a>. Alternatively, you can download the information you need directly from <a href="https://www.iucnredlist.org/">the IUCN Red List website</a>.</p>
<p>I’ve bundled up the Danish plant assessments in this package to make things easier for this analysis.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">danish_plants</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 4</span>
<span class="co">#&gt;   taxonid scientific_name        authority       category</span>
<span class="co">#&gt;     &lt;int&gt; &lt;chr&gt;                  &lt;chr&gt;           &lt;chr&gt;   </span>
<span class="co">#&gt; 1  193523 Acer campestre         L.              LC      </span>
<span class="co">#&gt; 2  193853 Acer platanoides       L.              LC      </span>
<span class="co">#&gt; 3  202910 Achillea ptarmica      L.              LC      </span>
<span class="co">#&gt; 4  165155 Aconitum napellus      (Nyár.) W.Seitz LC      </span>
<span class="co">#&gt; 5  168639 Acorus calamus         L.              LC      </span>
<span class="co">#&gt; 6  202914 Aesculus hippocastanum L.              VU</span></code></pre></div>
<p>In total, there are assessments for 361 vascular plants from Denmark.</p>
</div>
<div id="match-names-to-an-ipni-id" class="section level2">
<h2 class="hasAnchor">
<a href="#match-names-to-an-ipni-id" class="anchor"></a>2. Match names to an IPNI ID</h2>
<p>To match these names to an IPNI ID, we’ll use the Kew Names Matching Service. The first thing we’ll do, is join the taxonomic authority to the scientific name, to hopefully reduce the number of matches for each name.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">danish_plants</span> <span class="op">&lt;-</span>
  <span class="va">danish_plants</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span><span class="op">(</span><span class="st">"full_name"</span>, <span class="va">scientific_name</span>, <span class="va">authority</span>, sep<span class="op">=</span><span class="st">" "</span>, remove<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Then we put the full names through KNMS.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">full_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/match_knms.html">match_knms</a></span><span class="op">(</span><span class="va">danish_plants</span><span class="op">$</span><span class="va">full_name</span><span class="op">)</span>
<span class="va">full_matches</span>
<span class="co">#&gt; &lt;KNMS match: 361 names submitted&gt;</span>
<span class="co">#&gt; Matches returned: 349</span>
<span class="co">#&gt; Multiple matches: 4</span>
<span class="co">#&gt; Unmatched names: 8</span>
<span class="co">#&gt; List of 1</span>
<span class="co">#&gt;  $ :List of 4</span>
<span class="co">#&gt;   ..$ : chr "Acer campestre L."</span>
<span class="co">#&gt;   ..$ : chr "true"</span>
<span class="co">#&gt;   ..$ : chr "urn:lsid:ipni.org:names:781250-1"</span>
<span class="co">#&gt;   ..$ : chr "Acer campestre Sp. Pl.: 1055 (1753) L. 1753"</span></code></pre></div>
<p>Most of our names had matches! Which makes things simpler. But we also got some names that returned multiple matches.</p>
<p>First we’ll try putting just the scientific names of our missing matches through KNMS again.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">full_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">full_matches</span><span class="op">)</span>

<span class="va">unmatched</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">full_matches</span>, <span class="op">!</span><span class="va">matched</span><span class="op">)</span>

<span class="va">to_match</span> <span class="op">&lt;-</span> 
  <span class="va">danish_plants</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">full_name</span> <span class="op">%in%</span> <span class="va">unmatched</span><span class="op">$</span><span class="va">submitted</span><span class="op">)</span>

<span class="va">part_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/match_knms.html">match_knms</a></span><span class="op">(</span><span class="va">to_match</span><span class="op">$</span><span class="va">scientific_name</span><span class="op">)</span>
<span class="va">part_matches</span>
<span class="co">#&gt; &lt;KNMS match: 8 names submitted&gt;</span>
<span class="co">#&gt; Matches returned: 7</span>
<span class="co">#&gt; Multiple matches: 0</span>
<span class="co">#&gt; Unmatched names: 1</span>
<span class="co">#&gt; List of 1</span>
<span class="co">#&gt;  $ :List of 4</span>
<span class="co">#&gt;   ..$ : chr "Aconitum napellus"</span>
<span class="co">#&gt;   ..$ : chr "true"</span>
<span class="co">#&gt;   ..$ : chr "urn:lsid:ipni.org:names:707615-1"</span>
<span class="co">#&gt;   ..$ : chr "Aconitum napellus Sp. Pl.: 532 (1753) L. 1753"</span></code></pre></div>
<p>Almost everything returned a match. We could attempt to manually match the final name, but as it’s just one we’ll leave it out.</p>
<p>Now we can join all of our matches together, link them to the IUCN taxon ID, and resolve any synonyms.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">part_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">part_matches</span><span class="op">)</span>

<span class="va">full_matches</span> <span class="op">&lt;-</span> 
  <span class="va">full_matches</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">matched</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">danish_plants</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">taxonid</span>, <span class="va">full_name</span>, <span class="va">category</span><span class="op">)</span>,
    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"submitted"</span><span class="op">=</span><span class="st">"full_name"</span><span class="op">)</span>
  <span class="op">)</span>
  
<span class="va">part_matches</span> <span class="op">&lt;-</span> 
  <span class="va">part_matches</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">matched</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">danish_plants</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">taxonid</span>, <span class="va">scientific_name</span>, <span class="va">category</span><span class="op">)</span>,
    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"submitted"</span><span class="op">=</span><span class="st">"scientific_name"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">matched_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">full_matches</span>, <span class="va">part_matches</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">matched_names</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 6</span>
<span class="co">#&gt;   submitted                 matched ipni_id  matched_record     taxonid category</span>
<span class="co">#&gt;   &lt;chr&gt;                     &lt;lgl&gt;   &lt;chr&gt;    &lt;chr&gt;                &lt;int&gt; &lt;chr&gt;   </span>
<span class="co">#&gt; 1 Acer campestre L.         TRUE    781250-1 Acer campestre Sp…  193523 LC      </span>
<span class="co">#&gt; 2 Acer platanoides L.       TRUE    781455-1 Acer platanoides …  193853 LC      </span>
<span class="co">#&gt; 3 Achillea ptarmica L.      TRUE    2336-2   Achillea ptarmica…  202910 LC      </span>
<span class="co">#&gt; 4 Acorus calamus L.         TRUE    84009-1  Acorus calamus Sp…  168639 LC      </span>
<span class="co">#&gt; 5 Aesculus hippocastanum L. TRUE    781594-1 Aesculus hippocas…  202914 VU      </span>
<span class="co">#&gt; 6 Agrostis canina L.        TRUE    385537-1 Agrostis canina S…  167861 LC</span></code></pre></div>
</div>
<div id="resolve-assessments-to-accepted-names" class="section level2">
<h2 class="hasAnchor">
<a href="#resolve-assessments-to-accepted-names" class="anchor"></a>3. Resolve assessments to accepted names</h2>
<p>Now that we have an IPNI ID attached to each assessment, we can look up the record for the taxa in WCVP. This will let us find out the taxonomic status of each name - the first step in resolving any synonymy issues.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># wrap up the lookup_wcvp function to make sure it comes back as a list</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">taxonid</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../../reference/lookup_wcvp.html">lookup_wcvp</a></span><span class="op">(</span><span class="va">taxonid</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">resolved_names</span> <span class="op">&lt;-</span> 
  <span class="va">matched_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">taxonid</span>, <span class="va">ipni_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>wcvp_record<span class="op">=</span><span class="fu">f</span><span class="op">(</span><span class="va">ipni_id</span><span class="op">)</span><span class="op">)</span>

<span class="va">resolved_names</span> <span class="op">&lt;-</span>
  <span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>status<span class="op">=</span><span class="va">wcvp_record</span><span class="op">$</span><span class="va">status</span><span class="op">)</span></code></pre></div>
<p>With the taxonomic status, we’ll first remove any taxa that are unplaced. We’ll also remove any non-homotypic synonyms - even if we resolve these to accepted species, we can’t be sure that the assessment would be valid for the new concept, so that accepted species would not be assessed.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resolved_names</span> <span class="op">&lt;-</span>
  <span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">status</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"accepted"</span>, <span class="st">"homotypic synonym"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Next we’ll check if there are any taxa that still have multiple matches in WCVP.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">add_count</a></span><span class="op">(</span><span class="va">taxonid</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>multiple_matches<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;   multiple_matches</span>
<span class="co">#&gt;              &lt;int&gt;</span>
<span class="co">#&gt; 1                0</span></code></pre></div>
<p>There are not.</p>
<p>So the final step is to find the accepted names for all homotypic synonyms and remove anything that is a lower rank than species.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resolved_names</span> <span class="op">&lt;-</span>
  <span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accepted_id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"accepted"</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">accepted</span><span class="op">$</span><span class="va">id</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>,
         accepted_name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"accepted"</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">accepted</span><span class="op">$</span><span class="va">name</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">name</span><span class="op">)</span>,
         accepted_author<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"accepted"</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">accepted</span><span class="op">$</span><span class="va">author</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">authors</span><span class="op">)</span>,
         accepted_rank<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"accepted"</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">accepted</span><span class="op">$</span><span class="va">rank</span>,
                              <span class="va">wcvp_record</span><span class="op">$</span><span class="va">rank</span><span class="op">)</span><span class="op">)</span>

<span class="va">resolved_names</span> <span class="op">&lt;-</span> 
  <span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">wcvp_record</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>match_id<span class="op">=</span><span class="va">ipni_id</span><span class="op">)</span>

<span class="va">accepted_species</span> <span class="op">&lt;-</span>
  <span class="va">resolved_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">accepted_rank</span> <span class="op">==</span> <span class="st">"Species"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">accepted_species</span><span class="op">)</span>
<span class="co">#&gt; [1] 352</span></code></pre></div>
<p>We are now left with 352 accepted species from Denmark with assessments.</p>
</div>
<div id="get-a-list-of-all-species-in-the-country" class="section level2">
<h2 class="hasAnchor">
<a href="#get-a-list-of-all-species-in-the-country" class="anchor"></a>4. Get a list of all species in the country</h2>
<p>To calculate the number of species that are assessed in Denmark, we need a checklist of all accepted species.</p>
<p>We can get this from Plants of the World Online.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">checklist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/search_powo.html">search_powo</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>distribution<span class="op">=</span><span class="st">"Denmark"</span><span class="op">)</span>,
                         filters<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"accepted"</span>, <span class="st">"species"</span><span class="op">)</span>,
                         limit<span class="op">=</span><span class="fl">5000</span><span class="op">)</span>
<span class="va">checklist</span>
<span class="co">#&gt; &lt;POWO search: distribution='Denmark' filters: 'accepted, species'&gt;</span>
<span class="co">#&gt; total results: 2263</span>
<span class="co">#&gt; returned results: 2263</span>
<span class="co">#&gt; total pages: 1</span>
<span class="co">#&gt; First result:</span>
<span class="co">#&gt; List of 1</span>
<span class="co">#&gt;  $ :List of 9</span>
<span class="co">#&gt;   ..$ accepted: logi TRUE</span>
<span class="co">#&gt;   ..$ author  : chr "Wiinst."</span>
<span class="co">#&gt;   ..$ kingdom : chr "Plantae"</span>
<span class="co">#&gt;   ..$ family  : chr "Asteraceae"</span>
<span class="co">#&gt;   ..$ name    : chr "Hieracium adenoceps"</span>
<span class="co">#&gt;   ..$ rank    : chr "Species"</span>
<span class="co">#&gt;   ..$ snippet : chr " &lt;b&gt;Location&lt;/b&gt;: &lt;em&gt;Denmark&lt;/em&gt;"</span>
<span class="co">#&gt;   ..$ url     : chr "/taxon/urn:lsid:ipni.org:names:214408-1"</span>
<span class="co">#&gt;   ..$ fqId    : chr "urn:lsid:ipni.org:names:214408-1"</span></code></pre></div>
<p>Now we have this, we just need to join our assessments to our checklist.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">checklist</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">checklist</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ipni_id<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">fqId</span>, <span class="st">"[0-9\\-]+"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ipni_id</span>, <span class="va">family</span>, <span class="va">name</span>, <span class="va">author</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">ipni_id</span>, .keep_all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">accepted_species</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">accepted_id</span>, <span class="va">category</span><span class="op">)</span>,
    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ipni_id"</span><span class="op">=</span><span class="st">"accepted_id"</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
</div>
<div id="calculating-the-proportion-of-assessed-species" class="section level2">
<h2 class="hasAnchor">
<a href="#calculating-the-proportion-of-assessed-species" class="anchor"></a>5. Calculating the proportion of assessed species</h2>
<p>And now we can calculate the proportion of species assessed in Denmark!</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">checklist</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>p_assessed<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">category</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;   p_assessed</span>
<span class="co">#&gt;        &lt;dbl&gt;</span>
<span class="co">#&gt; 1      0.147</span></code></pre></div>
<p>And make a simple bar chart of the number of species in each category.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iucn_colours</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NE"</span><span class="op">=</span><span class="st">"#ffffff"</span>, 
                  <span class="st">"DD"</span><span class="op">=</span><span class="st">"#d1d1d6"</span>, 
                  <span class="st">"LC"</span><span class="op">=</span><span class="st">"#60c659"</span>, 
                  <span class="st">"NT"</span><span class="op">=</span><span class="st">"#cce226"</span>, 
                  <span class="st">"VU"</span><span class="op">=</span><span class="st">"#f9e814"</span>, 
                  <span class="st">"EN"</span><span class="op">=</span><span class="st">"#fc7f3f"</span>, 
                  <span class="st">"CR"</span><span class="op">=</span><span class="st">"d81e05"</span>, 
                  <span class="st">"EW"</span><span class="op">=</span><span class="st">"#542344"</span>, 
                  <span class="st">"EX"</span><span class="op">=</span><span class="st">"#000000"</span><span class="op">)</span>
<span class="va">checklist</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>category<span class="op">=</span><span class="st">"NE"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>category<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">category</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">iucn_colours</span><span class="op">)</span>,
                         ordered<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>mapping<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">category</span>, fill<span class="op">=</span><span class="va">category</span>,
                     colour<span class="op">=</span><span class="va">category</span> <span class="op">==</span> <span class="st">"NE"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="va">iucn_colours</span>, drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>`TRUE`<span class="op">=</span><span class="st">"black"</span>, `FALSE`<span class="op">=</span><span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="cn">FALSE</span>, colour<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Number of species"</span>, y<span class="op">=</span><span class="st">"IUCN Red List category"</span><span class="op">)</span>
<span class="co">#&gt; Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =</span>
<span class="co">#&gt; "none")` instead.</span></code></pre></div>
<p><img src="mapping-assessed-species_files/figure-html/plot-bars-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Barnaby Walker.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
